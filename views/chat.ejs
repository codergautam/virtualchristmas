<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
   <link rel="stylesheet" href="/chat.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Christmas</title>
    <!-- CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<title>Virtual Christmas!</title>  
<meta name="description" content= "Play an online Christmas game! Limited time event!" />
<meta name="robots" content= "index, follow">
<!-- jQuery and JS bundle w/ Popper.js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
</head>
<body style="background-color: #252535;">
  <style>

  </style>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">Virtual Christmas!</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home<span class="sr-only">(current)</span></a>
            </li>
    
                <li class="nav-item">
                    <a class="nav-link" href="/play">Play</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/inventory">Inventory</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/sell">Sell</a>
              </li>
                                    <li class="nav-item">
              <a class="nav-link" href="/leaderboard">Leaderboard</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="/chat">GameChat</a>
              </li>
          </ul>
           <ul class="navbar-nav">
              <li class="nav-item dropdown pull-right">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <%=uname%>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="/logout">Log out</a>
              </div>
            </li>
  
      </ul>
        </div>
      </nav>
<div style="background-color: #252535; height: 80%; padding-bottom: 8%;" class="container">
      <ul class="feed" id="feed"></ul>
          </div>
<div class="typing">                      <p style="color: white;" id="typing"></p></div>
    <form class="messaging-form"  id="chat" action="#">


        <div class="message-input">

            <input type="text" id="msg" class="message-input-field name-input" minlength="1" maxlength="256"/>
        </div>
        
        <button class="join" type="submit">Send</button>
    </form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
      <script>
          const addEntry = ({ user, message , time}, you) => {
    const entry = document.createElement('li');
    var message = message.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
       return '&#'+i.charCodeAt(0)+';';
    });
    entry.classList = `message-entry${you ? ' message-entry-own' : ''}`
    entry.innerHTML = `
        <div class="message-body">
            <a href="${window.location.origin}/inventory/${user}"><span class="user-name">${you ? 'You' : user}</span></a> 
            <p>${message}</p>
        </div>
    `;

    document.getElementById("feed").appendChild(entry);
};
scrollingElement = (document.scrollingElement || document.body)
function scrollToBottom () {
   scrollingElement.scrollTop = scrollingElement.scrollHeight;
}
      var typings = false
      var socket = io();
      function setTyping(typing) {
      if(!typings == typing) {
      typings = typing
      socket.emit("typing", {
      typing: typing,
                uname: "<%=uname%>",
                authorization: "<%=authorization%>"
      })
      }
      
      }
        $("#chat").submit((e) => {
  var msg =document.getElementById("msg").value.trim()
            e.preventDefault()
    if(msg.length < 1 || msg.length > 256) return
            socket.emit("msg", {
                msg: msg,
                uname: "<%=uname%>",
                authorization: "<%=authorization%>"
            })
            setTyping(false)
            scrollToBottom()
            document.getElementById("msg").value = ""
        })

        socket.on("msg", 
        (data) => {
            const you = ("<%=uname%>" == data.uname)
            const user = data.uname
            const message = data.msg
            const time = data.time
            var scroll = false
                           if($(window).scrollTop() + $(window).height() == $(document).height()) {scroll =true;
                           }

            addEntry({user, message, time}, you)
  if(scroll) scrollToBottom()
      
   
        })

        socket.on("users", (usercount) => {
        document.getElementById("msg").placeholder = `${usercount} users online`
        })

        socket.on("history", (history) => {
        history.forEach(data => {
                    const you = ("<%=uname%>" == data.uname)
            const user = data.uname
            const message = data.msg
            const time = data.time

            addEntry({user, message, time}, you) 
            scrollToBottom()
      
        })
        })
        $("#msg").bind('input', () => {
        setTyping(true);
        setTimeout(() => {
        if(typings) {
                setTyping(false)
        }

        }, 5000)
        })
      var userstyping = []
      socket.on("typing", (data)=> {

      if(data.typing) {
      if(!userstyping.includes(data.uname)) userstyping[userstyping.length] = data.uname 
      } else {
            if(userstyping.includes(data.uname)) userstyping = userstyping.filter(user=> user !== data.uname)
      }
      var typingp = document.getElementById("typing")
      var text = (userstyping.length > 0 ?
      userstyping.length == 1 ?
        `<b>${userstyping[0]}</b> is typing`
        : userstyping.length == 2 ?
        `<b>${userstyping[0]}</b> and <b>${userstyping[1]}</b> are typing` 
        : "Several people are typing"
      : "")

      typingp.innerHTML = text
      })
      </script>

</body>
</html>