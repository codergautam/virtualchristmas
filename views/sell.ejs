<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
   <link rel="stylesheet" href="/file.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Christmas</title>
    <!-- CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<title>Virtual Christmas!</title>  
<meta name="description" content= "Play an online Christmas game! Limited time event!" />
<meta name="robots" content= "index, follow">
<!-- jQuery and JS bundle w/ Popper.js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">Virtual Christmas!</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home<span class="sr-only">(current)</span></a>
            </li>
    
                <li class="nav-item">
                    <a class="nav-link" href="/play">Play</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/inventory">Inventory</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/sell">Sell</a>
                </li>
                                        <li class="nav-item">
              <a class="nav-link" href="/leaderboard">Leaderboard</a>
            </li>
                                    <li class="nav-item">
                <a class="nav-link" href="/chat" id="chat">GameChat</a>
              </li>
          </ul>
           <ul class="navbar-nav">
              <li class="nav-item dropdown pull-right">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <%=uname%>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="/logout">Log out</a>
              </div>
            </li>
  
      </ul>
        </div>
      </nav>

      

        
      </div>
      <%
      var map = {}
      for (sad in candy) { 
          map[candy[sad].name] = candy[sad]
        
        
    }

        %>
      <select onchange="schange()" style="width: 280px" id="select">
        <% for (candie in inv) { %>
            <option><%=candie%></option>
            <% } %>
      </select>
      <input type="number" onchange="nchange()" placeholder="Amount" id="amount" min=1>
      <button id="treat" onclick="treat()">Sell</button>
      <div id="sold" class="alert alert-primary" style="display: none;" role="alert"></div>
  <div id="notify" class="alert alert-primary" style="display: none;" role="alert"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
      <script>
      var socket = io();

           socket.on("msg", () => {
      $("#chat").html("GameChat(NEW MESSAGES)")
       $("#chat").css("color", "red");
      })

          window.onload = () => {
                          if($.isEmptyObject(inv)) {
                            disable()
                          }
            schange()
          }
            var notify = document.getElementById("notify")
            var sold = document.getElementById("sold")
          var inv = JSON.parse(`<%-JSON.stringify(inv)%>`)
          var map = JSON.parse(`<%-JSON.stringify(map)%>`)
          var select = document.getElementById("select")
          var number = document.getElementById("amount")
          sold.style.display = "none"
          function disable() {
                                          notify.style.display = ""
              number.style.display = "none"
              document.getElementById("treat").style.display = "none"
              select.style.display = "none"
              notify.innerHTML = "You dont have any gifts to sell!" 
          }
          function schange() {
            document.getElementById("treat").disabled = false
            number.value = 1
              number.max = inv[select.value].amount
                 notify.style.display = ""
             notify.innerHTML = `You have a total of ${number.max} ${select.value}s!<br> You will gain $${map[select.value].sell*number.value} by selling ${number.value} ${select.value}s!`

            
          }
function nchange() {
  document.getElementById("treat").disabled = false
  if(number.value <= number.max && number.value != "") {
         notify.style.display = ""
              notify.innerHTML = `You have a total of ${number.max} ${select.value}s!<br> You will gain $${map[select.value].sell*number.value} by selling ${number.value} ${select.value}s!`
  } else {
             notify.style.display = ""
              notify.innerHTML = `${(notify.innerHTML == "" ? "" : `${notify.innerHTML}<br><hr><br>`)}You only have ${number.max} ${select.value}s<br>Please select a number between 1-${number.max}`
               document.getElementById("treat").disabled = true
  }
           
}
          function mstosec(ms) {
              return (ms/1000).toFixed(2);
          }
       
          function treat() {
             if($.isEmptyObject(inv)) {
                            disable()
               return
                          }
            notify.style.display = "none";
       
            if(number.value <= number.max && number.value != "") {
            $.ajax({
            url: "/api/sell",
            method: "POST",
            data: {
                uname: "<%-uname%>",
                authorization: "<%-authorization%>",
                candy: select.value,
                amount: number.value

            },
            dataType: "JSON",
            success: function(data) {
              
              if(data.success) {
                sold.style.display = "";
                 sold.innerHTML = `You sold ${number.value} ${select.value}s and gained ${data.moneyearn} coins!`

                 inv = JSON.parse(data.inv)
                                 if($.isEmptyObject(inv)) {
                notify.style.display = ""
              number.style.display = "none"
              document.getElementById("treat").style.display = "none"
              select.style.display = "none"
              sold.style.display = "none"
              notify.innerHTML = notify.innerHTML+"<br><hr><br>You dont have any more gifts to sell!"

                          }
                var newselect = "";
                for (candie in inv) {
                    newselect += `<option>${candie}</option>`
                }
                if(newselect )
                select.innerHTML = newselect
                schange()
              } else {
                  alert("Unexpected Error: "+data.errormsg)
              }
            },
            error: function() {
                alert("Unexpected Error: Couldn't connect to server")
            }
        });
            } else {
              alert(`You only have ${number.max} ${select.value}s\nPlease select a number between 1-${number.max}`)
              number.value = 1
            }
    
          }
      </script>

</body>
</html>